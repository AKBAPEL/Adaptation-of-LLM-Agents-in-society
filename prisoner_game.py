from typing import List, Tuple, Dict, Callable
import random


def always_cooperate(history: List[Tuple[int, int]], agent_position: int, opponent_position: int) -> int:
    """–í—Å–µ–≥–¥–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å (0)"""
    return 0


def always_defect(history: List[Tuple[int, int]], agent_position: int, opponent_position: int) -> int:
    """–í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–∞–≤–∞—Ç—å (1)"""
    return 1


def tit_for_tat(history: List[Tuple[int, int]], agent_position: int, opponent_position: int) -> int:
    """
    –û–∫–æ –∑–∞ –æ–∫–æ (Tit-for-Tat):
    - –ü–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥: —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å
    - –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞—É–Ω–¥—ã: –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
    """
    if not history:
        return 0  # –ü–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥ - —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ–º

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è)
    last_round = history[-1]
    partner_decision = last_round[opponent_position]
    return partner_decision


def grim_trigger(history: List[Tuple[int, int]], agent_position: int, opponent_position: int) -> int:
    """
    –ì—Ä–æ–∑–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä (Grim Trigger):
    - –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ—Ç, –ø–æ–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä –Ω–µ –ø—Ä–µ–¥–∞—Å—Ç —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑
    - –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ - –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–∞–µ—Ç
    """
    if not history:
        return 0

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
    for round_history in history:
        partner_decision = round_history[opponent_position]
        if partner_decision == 1:  # –ü–∞—Ä—Ç–Ω–µ—Ä –ø—Ä–µ–¥–∞–ª —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑
            return 1
    return 0


def forgiving_tit_for_tat(history: List[Tuple[int, int]], agent_position: int, opponent_position: int) -> int:
    """
    –ü—Ä–æ—â–∞—é—â–∏–π –æ–∫–æ –∑–∞ –æ–∫–æ (Forgiving Tit-for-Tat):
    - –ü–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥: —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å
    - –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä –ø—Ä–µ–¥–∞–ª –≤ –ø—Ä–æ—à–ª–æ–º —Ä–∞—É–Ω–¥–µ, —Å 50% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Å—Ç–∏—Ç—å –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å
    - –ò–Ω–∞—á–µ: –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
    """
    if not history:
        return 0

    last_round = history[-1]
    partner_decision = last_round[opponent_position]

    if partner_decision == 1:  # –ü–∞—Ä—Ç–Ω–µ—Ä –ø—Ä–µ–¥–∞–ª –≤ –ø—Ä–æ—à–ª–æ–º —Ä–∞—É–Ω–¥–µ
        # –° 50% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –ø—Ä–æ—â–∞–µ–º –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ–º
        return 0 if random.random() < 0.5 else 1
    else:
        return 0  # –ü–∞—Ä—Ç–Ω–µ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–ª - —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ–º


def random_strategy(history: List[Tuple[int, int]], agent_position: int, opponent_position: int) -> int:
    """–°–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è"""
    return random.choice([0, 1])


# –°–ª–æ–≤–∞—Ä—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å –±–∏–Ω–¥–∞–º–∏
STRATEGIES: Dict[str, Callable[[List[Tuple[int, int]], int, int], int]] = {
    "AC": always_cooperate,  # Always Cooperate
    "AD": always_defect,  # Always Defect
    "TFT": tit_for_tat,  # Tit-for-Tat
    "GT": grim_trigger,  # Grim Trigger
    "FTFT": forgiving_tit_for_tat,  # Forgiving Tit-for-Tat
    "RAND": random_strategy  # Random Strategy
}


def calculate_payoffs(decision1: int, decision2: int) -> Tuple[int, int]:
    """
    –ú–∞—Ç—Ä–∏—Ü–∞ –≤—ã–∏–≥—Ä—ã—à–µ–π –¥–ª—è –¥–∏–ª–µ–º–º—ã –∑–∞–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ:
    (decision1, decision2) -> (payoff1, payoff2)

    0 = —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å, 1 = –ø—Ä–µ–¥–∞—Ç—å

    |          | –ü–∞—Ä—Ç–Ω–µ—Ä: 0 (C) | –ü–∞—Ä—Ç–Ω–µ—Ä: 1 (D) |
    |----------|---------------|---------------|
    | –ò–≥—Ä–æ–∫: 0 (C) | (3, 3)       | (0, 5)       |
    | –ò–≥—Ä–æ–∫: 1 (D) | (5, 0)       | (1, 1)       |
    """
    payoff_matrix = {
        (0, 0): (3, 3),  # –û–±–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—é—Ç
        (0, 1): (0, 5),  # –ò–≥—Ä–æ–∫ 1 —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ—Ç, –ò–≥—Ä–æ–∫ 2 –ø—Ä–µ–¥–∞–µ—Ç
        (1, 0): (5, 0),  # –ò–≥—Ä–æ–∫ 1 –ø—Ä–µ–¥–∞–µ—Ç, –ò–≥—Ä–æ–∫ 2 —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ—Ç
        (1, 1): (1, 1)  # –û–±–∞ –ø—Ä–µ–¥–∞—é—Ç
    }
    return payoff_matrix[(decision1, decision2)]


def simulate_prisoners_dilemma(
        strategy1_name: str,
        strategy2_name: str,
        rounds: int = 10,
        verbose: bool = False,
        noise_prob: float = 0.02
) -> Tuple[int, int, List[Tuple[int, int]], List[Tuple[int, int]]]:
    """
    –°–∏–º—É–ª–∏—Ä—É–µ—Ç –∏–≥—Ä—É –≤ –¥–∏–ª–µ–º–º—É –∑–∞–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –º–µ–∂–¥—É –¥–≤—É–º—è –∞–≥–µ–Ω—Ç–∞–º–∏ —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏

    Args:
        strategy1_name: –ò–º—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–µ—Ä–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (–∏–∑ STRATEGIES)
        strategy2_name: –ò–º—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤—Ç–æ—Ä–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (–∏–∑ STRATEGIES)
        rounds: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—É–Ω–¥–æ–≤ –∏–≥—Ä—ã

    Returns:
        Tuple[int, int, List[Tuple[int, int]], List[Tuple[int, int]]]:
        - total_payoff1: –û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à –ø–µ—Ä–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
        - total_payoff2: –û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à –≤—Ç–æ—Ä–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
        - history: –ò—Å—Ç–æ—Ä–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ [(decision_agent1, decision_agent2), ...]
        - payoffs_history: –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∏–≥—Ä—ã—à–µ–π –∑–∞ –∫–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥ [(payoff1, payoff2), ...]

    Raises:
        ValueError: –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–º—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    if strategy1_name not in STRATEGIES:
        raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞: {strategy1_name}")
    if strategy2_name not in STRATEGIES:
        raise ValueError(f" –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∞–≥–µ–Ω—Ç–∞: {strategy2_name}")

    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ –∏–º–µ–Ω–∞–º
    strategy1 = STRATEGIES[strategy1_name]
    strategy2 = STRATEGIES[strategy2_name]

    # –ü–æ–∑–∏—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤: 0 - –ø–µ—Ä–≤—ã–π –∞–≥–µ–Ω—Ç, 1 - –≤—Ç–æ—Ä–æ–π –∞–≥–µ–Ω—Ç
    agent1_position = 0
    agent2_position = 1

    total_payoff1 = 0
    total_payoff2 = 0
    history = []
    payoffs_history = []
    if verbose:
        print(f"üéÆ –ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ü–∏–∏: {strategy1_name} vs {strategy2_name} ({rounds} —Ä–∞—É–Ω–¥–æ–≤)")
        print("-" * 60)

    for round_num in range(rounds):
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ—à–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤
        decision1 = strategy1(history.copy(), agent1_position, agent2_position)
        decision2 = strategy2(history.copy(), agent2_position, agent1_position)
        if random.random() < noise_prob:
            decision1 = 1 - decision1  # –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ—à–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ 1
        if random.random() < noise_prob:
            decision2 = 1 - decision2  # –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ—à–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ 2
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à–∏ –∑–∞ —Ä–∞—É–Ω–¥
        payoff1, payoff2 = calculate_payoffs(decision1, decision2)

        # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏
        total_payoff1 += payoff1
        total_payoff2 += payoff2

        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        history.append((decision1, decision2))
        payoffs_history.append((payoff1, payoff2))

        if verbose:
            # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            print(f" –†–∞—É–Ω–¥ {round_num + 1}:")
            print(f"   –ê–≥–µ–Ω—Ç 1 ({strategy1_name}): {'–°–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ—Ç' if decision1 == 0 else '–ü—Ä–µ–¥–∞–µ—Ç'}")
            print(f"   –ê–≥–µ–Ω—Ç 2 ({strategy2_name}): {'–°–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ—Ç' if decision2 == 0 else '–ü—Ä–µ–¥–∞–µ—Ç'}")
            print(f"   –í—ã–∏–≥—Ä—ã—à–∏: –ê–≥–µ–Ω—Ç 1 = {payoff1}, –ê–≥–µ–Ω—Ç 2 = {payoff2}")
            print(f"   –û–±—â–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏: –ê–≥–µ–Ω—Ç 1 = {total_payoff1}, –ê–≥–µ–Ω—Ç 2 = {total_payoff2}")
            print("-" * 40)
    if verbose:
        print(f"üéØ –ò–¢–û–ì–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
        print(f"   –ê–≥–µ–Ω—Ç 1 ({strategy1_name}): {total_payoff1} –æ—á–∫–æ–≤")
        print(f"   –ê–≥–µ–Ω—Ç 2 ({strategy2_name}): {total_payoff2} –æ—á–∫–æ–≤")
        print(f"   –ò—Å—Ç–æ—Ä–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π: {history}")
        print("=" * 60)

    return total_payoff1, total_payoff2, history, payoffs_history

GAME_RULES = """–†–ï–ì–õ–ê–ú–ï–ù–¢ –ü–û–í–¢–û–†–Ø–Æ–©–ï–ô–°–Ø –î–ò–õ–ï–ú–ú–´ –ó–ê–ö–õ–Æ–ß–ï–ù–ù–´–•

üéØ –°–£–¢–¨ –ò–ì–†–´:
–í—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –º–Ω–æ–≥–æ—Ä–∞—É–Ω–¥–æ–≤–æ–π –∏–≥—Ä–µ —Å –¥—Ä—É–≥–∏–º –∞–≥–µ–Ω—Ç–æ–º. –í –∫–∞–∂–¥–æ–º —Ä–∞—É–Ω–¥–µ –≤—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –≤—ã–±–∏—Ä–∞–µ—Ç–µ –æ–¥–Ω–æ –∏–∑ –¥–≤—É—Ö –¥–µ–π—Å—Ç–≤–∏–π:
- 0 (–°–û–¢–†–£–î–ù–ò–ß–ê–¢–¨): —Ä–∞–±–æ—Ç–∞—Ç—å –≤–º–µ—Å—Ç–µ —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º
- 1 (–ü–†–ï–î–ê–¢–¨): –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —Å–≤–æ–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö

üìä –ú–ê–¢–†–ò–¶–ê –í–´–ò–ì–†–´–®–ï–ô (–æ—á–∫–∏ –∑–∞ –æ–¥–∏–Ω —Ä–∞—É–Ω–¥):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –í–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ   ‚îÇ –î–µ–π—Å—Ç–≤–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ ‚îÇ –í–∞—à–∏ –æ—á–∫–∏       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å (0)‚îÇ –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å (0)‚îÇ +3              ‚îÇ
‚îÇ –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å (0)‚îÇ –ü—Ä–µ–¥–∞—Ç—å (1)     ‚îÇ +0              ‚îÇ
‚îÇ –ü—Ä–µ–¥–∞—Ç—å (1)     ‚îÇ –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å (0)‚îÇ +5              ‚îÇ
‚îÇ –ü—Ä–µ–¥–∞—Ç—å (1)     ‚îÇ –ü—Ä–µ–¥–∞—Ç—å (1)     ‚îÇ +1              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚öñÔ∏è –í–ê–ñ–ù–û:
- –ò–≥—Ä–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ä–∞—É–Ω–¥–æ–≤ (—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
- –ö–∞–∂–¥–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é
- –í–∞—à–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏—è –≤–ª–∏—è–µ—Ç –Ω–∞ –±—É–¥—É—â–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏
- –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–∞—à–µ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
"""

